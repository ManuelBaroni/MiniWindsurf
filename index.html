<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windsurf Game v2</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #333;
            color: #fff;
            font-family: sans-serif;
        }
        canvas {
            border: 2px solid #fff;
        }
        h1 {
            margin-bottom: 10px;
        }
        p {
            margin-top: 5px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
</head>
<body>
    <h1>Windsurf Semplice (v2)</h1>
    <p>Usa ◀ FRECCIA SINISTRA e FRECCIA DESTRA ▶ per virare.</p>
    
    <script>
        // --- COSTANTI DI GIOCO ---
        // Vento: 0 = Nord (dall'alto), 90 = Est, 180 = Sud (dal basso), 270 = Ovest
        const WIND_DIRECTION_DEGREES = 45; // Vento da Nord-Est
        const WIND_SPEED = 0.08; // Forza del vento
        const NO_GO_ZONE_DEGREES = 45; // Ampiezza (per lato) dell'angolo in cui non si avanza

        // --- VARIABILI GLOBALI ---
        let board;
        let windVector;
        
        function setup() {
            createCanvas(800, 600);
            angleMode(RADIANS); // p5.js userà i radianti per gli angoli

            board = {
                pos: createVector(width / 2, height / 2),
                vel: createVector(0, 0),
                angle: 0,
                turnSpeed: 0.05,
                drag: 0.98,
                sailAngle: 0,
            };
            
            const windAngleRadians = radians(WIND_DIRECTION_DEGREES) - PI / 2;
            windVector = p5.Vector.fromAngle(windAngleRadians, 1); // Normalizzato, la forza la applichiamo dopo
        }

        function draw() {
            background(60, 120, 220); 

            handleInput();
            updatePhysics();
            
            drawWindsurf();
            drawWindIndicator();
        }

        function handleInput() {
            if (keyIsDown(LEFT_ARROW)) {
                board.angle -= board.turnSpeed;
            }
            if (keyIsDown(RIGHT_ARROW)) {
                board.angle += board.turnSpeed;
            }
        }

        function updatePhysics() {
            const boardDirectionVector = p5.Vector.fromAngle(board.angle - PI / 2);
            const angleBetween = boardDirectionVector.angleBetween(windVector);

            const noGoZoneRadians = radians(NO_GO_ZONE_DEGREES);
            let force = createVector(0, 0);

            // Controlliamo se la tavola sta puntando controvento, nella "no-go zone"
            // L'angolo PI (180°) rappresenta la direzione esattamente controvento.
            if (abs(angleBetween) > PI - noGoZoneRadians) {
                // SIAMO NELLA NO-GO ZONE
                // Nessuna forza di propulsione. La tavola rallenterà per la frizione.
                force = createVector(0, 0);
                
                // La vela "fileggia", non è gonfia e sta al centro.
                board.sailAngle = 0;

            } else {
                // SIAMO IN UNA ZONA CON PROPULSIONE
                // Calcoliamo la potenza. Usiamo Math.abs(sin(angle)) che è 0 controvento/poppa
                // e 1 (massimo) con vento al traverso (perpendicolare).
                const powerFactor = Math.abs(sin(angleBetween));
                
                // La forza di propulsione è nella direzione della tavola
                force = boardDirectionVector.copy().mult(powerFactor * WIND_SPEED);

                // Posizioniamo la vela automaticamente sul lato SOTTOVENTO
                // Usiamo il segno di sin(angleBetween) per capire se il vento viene da dx o sx.
                if (sin(angleBetween) > 0) {
                    // Vento da "sinistra" (rispetto alla tavola), mettiamo la vela a "destra"
                    board.sailAngle = PI / 3;
                } else {
                    // Vento da "destra", mettiamo la vela a "sinistra"
                    board.sailAngle = -PI / 3;
                }
            }
            
            // Applichiamo la forza di propulsione alla velocità
            board.vel.add(force);
            
            // Applichiamo la frizione dell'acqua
            board.vel.mult(board.drag);
            
            // Aggiorniamo la posizione
            board.pos.add(board.vel);

            // Gestione bordi schermo
            if (board.pos.x > width + 20) board.pos.x = -20;
            if (board.pos.x < -20) board.pos.x = width + 20;
            if (board.pos.y > height + 20) board.pos.y = -20;
            if (board.pos.y < -20) board.pos.y = height + 20;
        }

        function drawWindsurf() {
            push();
            translate(board.pos.x, board.pos.y);
            rotate(board.angle);

            // Tavola
            fill(240, 230, 140);
            noStroke();
            rectMode(CENTER);
            rect(0, 0, 15, 60);
            
            // Punta
            fill(210, 180, 140);
            triangle(0, -40, -7.5, -30, 7.5, -30);

            // Disegniamo albero e vela
            push();
            rotate(board.sailAngle);
            
            // Vela
            fill(255, 255, 255, 200);
            stroke(50);
            strokeWeight(2);
            rect(0, -25, 4, 50); // Simula l'albero con la vela attaccata
            
            pop(); // fine rotazione vela
            pop(); // fine rotazione tavola
        }

        function drawWindIndicator() {
            push();
            translate(50, 50);
            noFill();
            stroke(255, 255, 255, 150);
            strokeWeight(2);
            ellipse(0, 0, 40, 40);
            
            fill(255);
            noStroke();
            textAlign(CENTER, CENTER);
            text('N', 0, -28);

            rotate(radians(WIND_DIRECTION_DEGREES));
            stroke(255, 0, 0);
            strokeWeight(3);
            line(0, -10, 0, 15);
            fill(255, 0, 0);
            noStroke();
            triangle(0, 20, -5, 10, 5, 10);
            pop();
        }
    </script>
</body>
</html>

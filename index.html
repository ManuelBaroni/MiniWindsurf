<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windsurf Game v6 - Fisica e Vela Fluida (Bussola Corretta)</title>
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background-color: #333; color: #fff; font-family: sans-serif; }
        canvas { border: 2px solid #fff; }
        h1 { margin-bottom: 10px; } 
        p { margin-top: 5px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
</head>
<body>
    <h1>Windsurf Semplice (v6 - Fisica e Vela Fluida)</h1>
    <p>Usa ◀ FRECCIA SINISTRA e FRECCIA DESTRA ▶ per virare.</p>
<script>
    // --- COSTANTI DI GIOCO ---
    const WIND_DIRECTION_DEGREES = 0;     // 0 = Nord (vento “verso” il basso sullo schermo)
    const WIND_SPEED = 0.01;              // Forza del vento
    const NO_GO_ZONE_DEGREES = 15;        // Ampiezza per lato in bolina stretta

    // --- VARIABILI GLOBALI ---
    let board;
    let windVector;
    
    function setup() {
        createCanvas(800, 600);
        angleMode(RADIANS);

        board = {
            pos: createVector(width / 2, height / 2),
            vel: createVector(0, 0),
            angle: 0,              // direzione prua della tavola
            turnSpeed: 0.05,
            drag: 0.98,
            sailAngle: 0,          // stato attuale della vela (in radianti)
            targetSailAngle: 0,    // angolo di vela desiderato (in radianti)
            sailLerp: 0.1,         // velocità di interpolazione (più piccolo = più fluido)
            debug_angleBetween: 0,
            debug_powerFactor: 0,
        };
        
        // Creiamo windVector in modo che punti VERSO la tavola dalla direzione da cui proviene il vento:
        // Se WIND_DIRECTION_DEGREES = 0 (Nord), allora il vento soffia verso il basso.
        const windAngleRadians = radians(WIND_DIRECTION_DEGREES) - PI / 2;
        windVector = p5.Vector.fromAngle(windAngleRadians, 1);
    }

    function draw() {
        background(60, 120, 220);
        handleInput();
        updatePhysics();
        drawWindsurf();
        drawWindIndicator();
        drawDebugInfo();
    }

    function handleInput() {
        if (keyIsDown(LEFT_ARROW)) {
            board.angle -= board.turnSpeed;
        }
        if (keyIsDown(RIGHT_ARROW)) {
            board.angle += board.turnSpeed;
        }
    }

    function updatePhysics() {
        // 1) Vettore di direzione della prua (board.angle punta verso la prua)
        const boardDir = p5.Vector.fromAngle(board.angle - PI / 2);

        // 2) Angolo tra prua e vento (windVector → boardDir), in [-π, +π]
        const angleBetween = windVector.angleBetween(boardDir);
        const absAngle = abs(angleBetween);

        // 3) Segno in base al lato da cui arriva il vento:
        //    cross > 0 → vento arriva da sinistra, vela va a destra (+)
        //    cross < 0 → vento arriva da destra, vela va a sinistra (−)
        const cross = windVector.x * boardDir.y - windVector.y * boardDir.x;
        const sideSign = (cross > 0) ? 1 : -1;

        const noGo = radians(NO_GO_ZONE_DEGREES);
        let powerFactor = 0;
        let target = 0;

        // 4a) Bolina stretta (absAngle < noGo): nessuna propulsione, vela a 180° (piatta di fronte)
        if (absAngle < noGo) {
            powerFactor = 0;
            target = PI;

        // 4b) Poppa stretta (absAngle > π - noGo): poca propulsione, vela a ±90°
        } else if (absAngle > PI - noGo) {
            powerFactor = 0.2;
            target = sideSign * (PI / 2);

        // 4c) Bolina larga, traverso, lasco: potenza variabile, vela variabile
        } else {
            powerFactor = sin(absAngle);
            // sailMag = π − 0.5 * absAngle
            let sailMag = PI - 0.5 * absAngle;
            target = sideSign * sailMag;
        }

        // 5) Interpolazione fluida della vela
        board.sailAngle += (target - board.sailAngle) * board.sailLerp;
        board.debug_angleBetween = angleBetween;
        board.debug_powerFactor = powerFactor;

        // 6) Forza propulsiva lungo la prua
        const force = boardDir.copy().mult(powerFactor * WIND_SPEED);
        board.vel.add(force);
        board.vel.mult(board.drag);
        board.pos.add(board.vel);

        // 7) Wrapping ai bordi
        if (board.pos.x > width + 20)  board.pos.x = -20;
        if (board.pos.x < -20)         board.pos.x = width + 20;
        if (board.pos.y > height + 20) board.pos.y = -20;
        if (board.pos.y < -20)         board.pos.y = height + 20;
    }

    // --- DISEGNO DEL WINDSURF ---
   function drawWindsurf() {
    push();
    translate(board.pos.x, board.pos.y);
    rotate(board.angle);

    // --- TAVOLA DETTAGLIATA ---
    noStroke();
    fill(240, 230, 140);
    beginShape();
    // Disegnamo contorni smussati della tavola
    vertex(-10, 30);
    vertex(10, 30);
    vertex(14, 20);
    vertex(14, -20);
    vertex(10, -30);
    vertex(-10, -30);
    vertex(-14, -20);
    vertex(-14, 20);
    endShape(CLOSE);

    // Foot straps (dettaglio imbottiture)
    stroke(80);
    strokeWeight(2);
    noFill();
    arc(0, 0, 40, 20, PI + 0.5, PI + 2.6);   // strap posteriore
    arc(0, 10, 40, 20, PI + 0.5, PI + 2.6);  // strap anteriore

    // Aleta (fin) sotto la tavola
    noStroke();
    fill(100, 50, 0);
    beginShape();
    vertex(-4, 30);
    vertex(4, 30);
    vertex(5, 42);
    vertex(0, 55);
    vertex(-5, 42);
    endShape(CLOSE);

    // --- MAST E BOOM CON DETTAGLI ---
    push();
    translate(0, -15);          // punto di attacco dell'albero (circa 15px sopra il centro)
    // Albero (mast) con dettaglio nodi
    stroke(80);
    strokeWeight(5);
    line(0, 0, 0, -100);
    // Dettagli nodi (anelli)
    strokeWeight(1);
    for (let y = -20; y > -100; y -= 20) {
        noFill();
        stroke(60);
        ellipse(0, y, 8, 8);
    }
    // Boom (orizzontale) con grip e impugnature
    stroke(80);
    strokeWeight(4);
    line(0, -60, 60, -60);
    line(0, -60, -60, -60);
    // Grip del boom (impugnature)
    stroke(120);
    strokeWeight(8);
    // lato destro
    line(40, -60, 20, -60);
    // lato sinistro
    line(-40, -60, -20, -60);
    pop();

    // --- VELA CON DETTAGLI DYNAMICHI BASED ON board.sailAngle ---
    push();
    translate(0, -15);
    rotate(board.sailAngle);

    // Profilo della vela (forma più naturale, con curva inferiore)
    noStroke();
    fill(255, 255, 255, 200);
    beginShape();
    vertex(0, 0);            // piede dell'albero
    vertex(60, -60);         // punto sul boma verso prua
    vertex(50, -100);        // parte superiore curva
    vertex(20, -120);        // punta vela
    vertex(0, -100);         // retro vela
    endShape(CLOSE);

    // Dettagli battens (stecche) - linee diagonali
    stroke(200);
    strokeWeight(2);
    line(0, -20, 48, -44);
    line(0, -40, 40, -80);
    line(0, -60, 28, -104);

    // Profilo cuciture (piccole linee orizzontali)
    stroke(180);
    strokeWeight(1);
    for (let y = -10; y > -100; y -= 15) {
        line(0, y, map(y, -10, -100, 30, 45), y - 2);
    }

    pop();
    pop();
}


    // --- INDICATORE DEL VENTO (BUSSOLA CORRETTA) ---
    function drawWindIndicator() {
        push();
        translate(50, 50);
        noFill();
        stroke(255, 255, 255, 150);
        strokeWeight(2);
        ellipse(0, 0, 40, 40);

        fill(255);
        noStroke();
        textAlign(CENTER, CENTER);
        text('N', 0, -28);

        // RUOTIAMO DI -WIND_DIRECTION_DEGREES per avere la bussola non invertita
        rotate(-radians(WIND_DIRECTION_DEGREES));
        stroke(255, 0, 0);
        strokeWeight(3);
        line(0, -10, 0, 15);
        fill(255, 0, 0);
        noStroke();
        triangle(0, 20, -5, 10, 5, 10);
        pop();
    }

    // --- DEBUG INFO SULLO SCHERMO ---
    function drawDebugInfo() {
        const windVecAngle = degrees(windVector.heading());
        const boardAngle = degrees(board.angle % TWO_PI);
        const relativeAngle = degrees(board.debug_angleBetween);
        const sailAngle = degrees(board.sailAngle);
        const power = board.debug_powerFactor;
        const speed = board.vel.mag();

        push();
        fill(255, 255, 0);
        noStroke();
        textSize(14);
        textAlign(RIGHT, TOP);
        textFont('monospace');
        let x = width - 10;
        let y = 10;
        const lineHeight = 18;

        text(`--- DEBUG INFO ---`, x, y); y += lineHeight * 1.5;
        text(`Vento da (const): ${WIND_DIRECTION_DEGREES.toFixed(1)}°`, x, y); y += lineHeight;
        text(`Vettor Vento Dir: ${windVecAngle.toFixed(1)}°`, x, y); y += lineHeight;
        text(`Angolo Tavola: ${boardAngle.toFixed(1)}°`, x, y); y += lineHeight;
        text(`Ang Tavola≡Vento: ${relativeAngle.toFixed(1)}°`, x, y); y += lineHeight * 1.5;
        text(`Angolo Vela: ${sailAngle.toFixed(1)}°`, x, y); y += lineHeight;
        text(`Fattor Potenza: ${power.toFixed(2)}`, x, y); y += lineHeight;
        text(`Velocità: ${speed.toFixed(3)}`, x, y);
        pop();
    }
</script>
</body>
</html>
